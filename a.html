<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CKEditor 5 - Quick start với Upload Ảnh</title>
    <!-- Sử dụng file local -->
    <link rel="stylesheet" href="ckeditor5.css">
    <style>
        .main-container {
            width: 795px;
            margin-left: auto;
            margin-right: auto;
        }
        .ck-editor__editable { min-height: 200px; }
        #output { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
        button { margin: 10px 0; padding: 8px 16px; }
        .error { color: red; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="editor">
            <p>Hello from CKEditor 5!</p>
        </div>
        <button onclick="getContent()">Lấy nội dung</button>
        <div id="output"></div>
        <div id="error" class="error"></div>
    </div>
    <script src="ckeditor5.umd.js"></script>
    <script>
        const {
            ClassicEditor,
            Essentials,
            Bold,
            Italic,
            Font,
            Paragraph,
            Image,
            ImageToolbar,
            ImageStyle,
            ImageUpload,
            FileRepository
        } = CKEDITOR;

        // Custom upload adapter cho ảnh (base64)
        class MyUploadAdapter {
            constructor(loader) {
                this.loader = loader;
            }

            upload() {
                return this.loader.file.then(file => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve({ default: reader.result });
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                }));
            }

            abort() {}
        }

        // Plugin để thêm upload adapter
        function MyCustomUploadAdapterPlugin(editor) {
            editor.plugins.get('FileRepository').createUploadAdapter = loader => new MyUploadAdapter(loader);
        }

        // Khởi tạo CKEditor
        window.addEventListener('DOMContentLoaded', () => {
            if (typeof ClassicEditor === 'undefined') {
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = 'Lỗi: Không tìm thấy CKEditor. Vui lòng kiểm tra file ckeditor5.umd.js trong thư mục.';
                console.error('CKEditor không được tải. Đảm bảo file ckeditor5.umd.js tồn tại.');
                return;
            }

            ClassicEditor
                .create(document.querySelector('#editor'), {
                    licenseKey: 'eyJhbGciOiJFUzI1NiJ9.eyJleHAiOjE3NTU2NDc5OTksImp0aSI6IjQzNWJhM2ZmLTZlMDEtNDU5ZS05ZDMzLWRjNmI3NGY0MjY4ZSIsInVzYWdlRW5kcG9pbnQiOiJodHRwczovL3Byb3h5LWV2ZW50LmNrZWRpdG9yLmNvbSIsImRpc3RyaWJ1dGlvbkNoYW5uZWwiOlsiY2xvdWQiLCJkcnVwYWwiLCJzaCJdLCJ3aGl0ZUxhYmVsIjp0cnVlLCJsaWNlbnNlVHlwZSI6InRyaWFsIiwiZmVhdHVyZXMiOlsiKiJdLCJ2YyI6IjZjM2VmNDgxIn0.Dynax5NXZsZyUzGK5LgAZJK9JS98q-FyfORECJg-3uCiaQVM1GEQADaN2boBNzUo3Ve6Q_k4j7i2BS5u1sHaGQ',
                    plugins: [
                        Essentials, Bold, Italic, Font, Paragraph,
                        Image, ImageToolbar, ImageStyle, ImageUpload, FileRepository
                    ],
                    toolbar: [
                        'undo', 'redo', '|', 'bold', 'italic', '|',
                        'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', '|',
                        'imageUpload', 'blockQuote', 'insertTable'
                    ],
                    image: {
                        toolbar: [
                            'imageStyle:inline',
                            'imageStyle:block',
                            'imageStyle:side',
                            '|',
                            'toggleImageCaption',
                            'imageTextAlternative'
                        ]
                    }
                })
                .then(editor => {
                    window.editor = editor;
                    console.log('Editor khởi tạo thành công!');
                })
                .catch(error => {
                    console.error('Lỗi khởi tạo CKEditor:', error);
                    document.getElementById('error').textContent = 'Lỗi khởi tạo editor: ' + error.message;
                });
        });

        // Lấy nội dung từ editor
        function getContent() {
            if (!window.editor) {
                document.getElementById('error').textContent = 'Editor chưa sẵn sàng. Vui lòng thử lại sau vài giây.';
                console.error('Editor chưa được khởi tạo.');
                return;
            }
            const content = window.editor.getData();
            document.getElementById('output').innerHTML = content;
            document.getElementById('error').textContent = '';
        }
    </script>
</body>
</html>